{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-body text-center">
                    {% if current_user.photo_path %}
                        <img src="{{ url_for('static', filename=current_user.photo_path) }}" 
                             class="rounded-circle mb-3" style="width: 150px; height: 150px; object-fit: cover;" 
                             alt="Profile Photo"
                             onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2NjY2NjYyI+PHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyczQuNDggMTAgMTAgMTAgMTAtNC40OCAxMC0xMFMxNy41MiAyIDEyIDJ6bTAgM2MyLjY3IDAgNC44NCAyLjE3IDQuODQgNC44NCAwIDIuNjctMi4xNyA0Ljg0LTQuODQgNC44NC0yLjY3IDAtNC44NC0yLjE3LTQuODQtNC44NCAwLTIuNjcgMi4xNy00Ljg0IDQuODQtNC44NHptMCAxMmM0LjQyIDAgOC4xNy0yLjI4IDkuNTQtNS41NS0yLjU4LTEuOTktNS45NC0zLjE3LTkuNTQtMy4xNy0zLjYgMC02Ljk2IDEuMTgtOS41NCAzLjE3IDEuMzcgMy4yNyA1LjEyIDUuNTUgOS41NCA1LjU1eiIvPjwvc3ZnPg=='">
                    {% else %}
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2NjY2NjYyI+PHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyczQuNDggMTAgMTAgMTAgMTAtNC40OCAxMC0xMFMxNy41MiAyIDEyIDJ6bTAgM2MyLjY3IDAgNC44NCAyLjE3IDQuODQgNC44NCAwIDIuNjctMi4xNyA0Ljg0LTQuODQgNC44NC0yLjY3IDAtNC44NC0yLjE3LTQuODQtNC44NCAwLTIuNjcgMi4xNy00Ljg0IDQuODQtNC44NHptMCAxMmM0LjQyIDAgOC4xNy0yLjI4IDkuNTQtNS41NS0yLjU4LTEuOTktNS45NC0zLjE3LTkuNTQtMy4xNy0zLjYgMC02Ljk2IDEuMTgtOS41NCAzLjE3IDEuMzcgMy4yNyA1LjEyIDUuNTUgOS41NCA1LjU1eiIvPjwvc3ZnPg==" 
                             class="rounded-circle mb-3" style="width: 150px; height: 150px; object-fit: cover;" 
                             alt="Default Profile Photo">
                    {% endif %}
                    <h4>{{ current_user.name or 'User' }}</h4>
                    <p class="text-muted">{{ current_user.email }}</p>
                    {% if current_user.aadhar_number %}
                        <p class="text-muted">Aadhar: {{ current_user.aadhar_number }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <!-- Pending Invitations Section -->
            <div class="card mb-4" id="pendingInvitationsCard" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0">Pending Exam Invitations</h5>
                </div>
                <div class="card-body">
                    <div id="pendingInvitationsList"></div>
                </div>
            </div>

            <!-- Available Exams Section -->
            <div class="card mb-4" id="availableExamsCard" style="display: none;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Available Exams</h5>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#demoExamModal">Demo Exam</button>
                </div>
                <div class="card-body">
                    <div id="availableExamsList"></div>
                </div>
            </div>

            <!-- Default message when no exams -->
            <div class="card mb-4" id="noExamsCard">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Upcoming Exams</h5>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#demoExamModal">Demo Exam</button>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        No upcoming exams scheduled.
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Exam History</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        No exam history available.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Demo Exam Modal -->
<div class="modal fade" id="demoExamModal" tabindex="-1" aria-labelledby="demoExamModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="demoExamModalLabel">Demo Exam - Face Verification</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <video id="demoWebcam" width="320" height="240" autoplay playsinline style="border:1px solid #ccc;"></video>
        <canvas id="demoCanvas" width="320" height="240" style="display:none;"></canvas>
        <div id="demoResult" class="mt-3"></div>
        <div id="liveStatus" class="mt-4" style="display:none;">
          <h6>Live Proctoring Status</h6>
          <div>Faces detected: <span id="statusNumFaces">-</span></div>
          <div>Head pose: <span id="statusHeadPose">-</span></div>
          <div>Left eye: <span id="statusLeftEyeDir">-</span></div>
          <div>Right eye: <span id="statusRightEyeDir">-</span></div>
          <div class="d-flex mt-2">
            <div class="me-2 text-center">
              <div style="font-size:0.9em;">Left Eye</div>
              <img id="statusLeftEyeImg" src="" width="80" height="48" style="border:1px solid #ccc;object-fit:cover;"/>
            </div>
            <div class="text-center">
              <div style="font-size:0.9em;">Right Eye</div>
              <img id="statusRightEyeImg" src="" width="80" height="48" style="border:1px solid #ccc;object-fit:cover;"/>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="captureDemoBtn">Capture & Verify</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Accept Invitation Modal -->
<div class="modal fade" id="acceptInvitationModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Accept Exam Invitation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="invitationDetails"></div>
        <div class="mb-3">
          <label for="invitationCode" class="form-label">Invitation Code</label>
          <input type="text" class="form-control" id="invitationCode" placeholder="Enter invitation code">
        </div>
        <div id="invitationStatus"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="acceptInvitationBtn">Accept Invitation</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
{% block scripts %}
{{ super() }}
<script>
// Only declare these variables ONCE at the top of the script
let demoStream = null;
let proctoringInterval = null;
const demoWebcam = document.getElementById('demoWebcam');
const demoCanvas = document.getElementById('demoCanvas');
const demoResult = document.getElementById('demoResult');
const captureDemoBtn = document.getElementById('captureDemoBtn');
const liveStatusDiv = document.getElementById('liveStatus');
const statusNumFaces = document.getElementById('statusNumFaces');
const statusHeadPose = document.getElementById('statusHeadPose');
const statusLeftEyeDir = document.getElementById('statusLeftEyeDir');
const statusRightEyeDir = document.getElementById('statusRightEyeDir');
const statusLeftEyeImg = document.getElementById('statusLeftEyeImg');
const statusRightEyeImg = document.getElementById('statusRightEyeImg');

// Load dashboard data when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
});

async function loadDashboardData() {
    try {
        // Load pending invitations
        const invitationsResponse = await fetch('/api/exam/pending-invitations');
        const invitationsData = await invitationsResponse.json();
        
        if (invitationsData.pending_invitations && invitationsData.pending_invitations.length > 0) {
            displayPendingInvitations(invitationsData.pending_invitations);
        }
        
        // Load available exams
        const examsResponse = await fetch('/api/exam/available');
        const examsData = await examsResponse.json();
        
        if (examsData.exams && examsData.exams.length > 0) {
            displayAvailableExams(examsData.exams);
        }
        
        // Show/hide appropriate cards
        updateCardVisibility();
    } catch (error) {
        console.error('Error loading dashboard data:', error);
    }
}

function displayPendingInvitations(invitations) {
    const container = document.getElementById('pendingInvitationsList');
    const card = document.getElementById('pendingInvitationsCard');
    
    if (invitations.length === 0) {
        card.style.display = 'none';
        return;
    }
    
    const html = invitations.map(invitation => `
        <div class="card mb-2">
            <div class="card-body">
                <h6 class="card-title">${invitation.exam_title}</h6>
                <p class="card-text">${invitation.exam_description || 'No description available'}</p>
                <p class="text-muted small">Invitation Code: <strong>${invitation.invitation_code}</strong></p>
                <button class="btn btn-primary btn-sm" onclick="showAcceptInvitation('${invitation.exam_title}', '${invitation.invitation_code}')">
                    Accept Invitation
                </button>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
    card.style.display = 'block';
}

function displayAvailableExams(exams) {
    const container = document.getElementById('availableExamsList');
    const card = document.getElementById('availableExamsCard');
    
    if (exams.length === 0) {
        card.style.display = 'none';
        return;
    }
    
    const html = exams.map(exam => {
        const startTime = new Date(exam.start_time).toLocaleString();
        const endTime = new Date(exam.end_time).toLocaleString();
        const now = new Date();
        const examStart = new Date(exam.start_time);
        const examEnd = new Date(exam.end_time);
        
        let status = 'Upcoming';
        let statusClass = 'bg-info';
        
        if (now >= examStart && now <= examEnd) {
            status = 'Active';
            statusClass = 'bg-success';
        } else if (now > examEnd) {
            status = 'Completed';
            statusClass = 'bg-secondary';
        }
        
        return `
            <div class="card mb-2">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title">${exam.title}</h6>
                            <p class="card-text">${exam.description || 'No description available'}</p>
                            <p class="text-muted small">
                                <strong>Duration:</strong> ${exam.duration} minutes<br>
                                <strong>Total Marks:</strong> ${exam.total_marks}<br>
                                <strong>Start:</strong> ${startTime}<br>
                                <strong>End:</strong> ${endTime}
                            </p>
                        </div>
                        <span class="badge ${statusClass}">${status}</span>
                    </div>
                    ${now >= examStart && now <= examEnd ? 
                        `<button class="btn btn-success btn-sm" onclick="startExam(${exam.id})">Start Exam</button>` : 
                        ''
                    }
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = html;
    card.style.display = 'block';
}

function updateCardVisibility() {
    const pendingCard = document.getElementById('pendingInvitationsCard');
    const availableCard = document.getElementById('availableExamsCard');
    const noExamsCard = document.getElementById('noExamsCard');
    
    const hasPending = pendingCard.style.display !== 'none';
    const hasAvailable = availableCard.style.display !== 'none';
    
    if (!hasPending && !hasAvailable) {
        noExamsCard.style.display = 'block';
    } else {
        noExamsCard.style.display = 'none';
    }
}

function showAcceptInvitation(examTitle, invitationCode) {
    document.getElementById('invitationDetails').innerHTML = `
        <div class="alert alert-info">
            <strong>Exam:</strong> ${examTitle}<br>
            <strong>Code:</strong> ${invitationCode}
        </div>
    `;
    document.getElementById('invitationCode').value = invitationCode;
    document.getElementById('invitationStatus').innerHTML = '';
    new bootstrap.Modal(document.getElementById('acceptInvitationModal')).show();
}

document.getElementById('acceptInvitationBtn').addEventListener('click', async function() {
    const invitationCode = document.getElementById('invitationCode').value.trim();
    
    if (!invitationCode) {
        document.getElementById('invitationStatus').innerHTML = `
            <div class="alert alert-danger">Please enter an invitation code</div>
        `;
        return;
    }
    
    try {
        const response = await fetch('/api/exam/accept-invitation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ invitation_code: invitationCode })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            document.getElementById('invitationStatus').innerHTML = `
                <div class="alert alert-success">${data.message}</div>
            `;
            // Reload dashboard data after successful acceptance
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('acceptInvitationModal')).hide();
                loadDashboardData();
            }, 1500);
        } else {
            document.getElementById('invitationStatus').innerHTML = `
                <div class="alert alert-danger">${data.error}</div>
            `;
        }
    } catch (error) {
        console.error('Error accepting invitation:', error);
        document.getElementById('invitationStatus').innerHTML = `
            <div class="alert alert-danger">An error occurred while accepting the invitation</div>
        `;
    }
});

function startExam(examId) {
    // Redirect to exam interface
    window.location.href = `/exam/${examId}`;
}

// Open webcam when modal is shown
const demoExamModal = document.getElementById('demoExamModal');
demoExamModal.addEventListener('shown.bs.modal', async () => {
    demoResult.innerHTML = '';
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        demoStream = await navigator.mediaDevices.getUserMedia({ video: true });
        demoWebcam.srcObject = demoStream;
    }
});
// Stop webcam when modal is hidden
demoExamModal.addEventListener('hidden.bs.modal', () => {
    if (demoStream) {
        demoStream.getTracks().forEach(track => track.stop());
        demoStream = null;
    }
    demoWebcam.srcObject = null;
    // Re-enable and show the capture button for next use
    captureDemoBtn.disabled = false;
    captureDemoBtn.style.display = '';
    // Hide live status and stop polling
    liveStatusDiv.style.display = 'none';
    stopLiveProctoring();
});

captureDemoBtn.onclick = async function() {
    // Capture frame
    demoCanvas.getContext('2d').drawImage(demoWebcam, 0, 0, demoCanvas.width, demoCanvas.height);
    const dataUrl = demoCanvas.toDataURL('image/jpeg');
    const base64 = dataUrl.split(',')[1];
    demoResult.innerHTML = '<div class="text-info">Verifying...</div>';
    // Send to backend
    try {
        const response = await fetch('/api/demo_exam/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: base64 })
        });
        const result = await response.json();
        if (result.success) {
            demoResult.innerHTML = `<div class='text-success'>✅ Verification successful!<br>Starting proctoring...</div>`;
            captureDemoBtn.disabled = true;
            captureDemoBtn.style.display = 'none';
            // Start proctoring
            try {
                const proctorResp = await fetch('/api/demo_exam/proctor', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const proctorResult = await proctorResp.json();
                if (proctorResult.success) {
                    demoResult.innerHTML += `<div class='text-success mt-2'>🛡️ Proctoring started. Please keep this window open.</div>`;
                    liveStatusDiv.style.display = '';
                    startLiveProctoring();
                } else {
                    demoResult.innerHTML += `<div class='text-danger mt-2'>Failed to start proctoring: ${proctorResult.error || ''}</div>`;
                }
            } catch (err) {
                demoResult.innerHTML += `<div class='text-danger mt-2'>Error starting proctoring: ${err}</div>`;
            }
        } else {
            demoResult.innerHTML = `<div class='text-danger'>❌ Verification failed. ${result.error || ''}</div>`;
        }
    } catch (err) {
        demoResult.innerHTML = `<div class='text-danger'>Error: ${err}</div>`;
    }
};

async function startLiveProctoring() {
    proctoringInterval = setInterval(async () => {
        demoCanvas.getContext('2d').drawImage(demoWebcam, 0, 0, demoCanvas.width, demoCanvas.height);
        const dataUrl = demoCanvas.toDataURL('image/jpeg');
        const base64 = dataUrl.split(',')[1];
        try {
            const response = await fetch('/api/proctoring/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: base64 })
            });
            const status = await response.json();
            statusNumFaces.textContent = status.num_faces;
            statusHeadPose.textContent = status.head_pose;
            statusLeftEyeDir.textContent = status.left_eye_dir;
            statusRightEyeDir.textContent = status.right_eye_dir;
            statusLeftEyeImg.src = status.left_eye_img ? `data:image/jpeg;base64,${status.left_eye_img}` : '';
            statusRightEyeImg.src = status.right_eye_img ? `data:image/jpeg;base64,${status.right_eye_img}` : '';
        } catch (err) {
            // Optionally show error in UI
        }
    }, 1000);
}

function stopLiveProctoring() {
    if (proctoringInterval) {
        clearInterval(proctoringInterval);
        proctoringInterval = null;
    }
}
</script>
{% endblock %} 